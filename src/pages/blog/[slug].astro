---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogSidebar from '../../components/BlogSidebar.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import Giscus from '../../components/Giscus.astro';
import { render } from 'astro:content';
import { getReadingTime, parseCategory, splitContent, translateCategory } from '../../lib/utils';
import { base, assetPath, getCategoryI18n } from '../../lib/config';
import { TAG_COLORS, CAT_COLOR_MAP } from '../../lib/constants';
import { getPublishedPosts } from '../../lib/posts';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();

  return posts.map((post, index) => {
    const parentCat = parseCategory(post.data.category).parent;
    let relatedPosts = posts
      .filter((p) => p.id !== post.id && parseCategory(p.data.category).parent === parentCat)
      .slice(0, 4);

    // Fallback: if no same-category posts, show recent posts
    const isSameCategory = relatedPosts.length > 0;
    if (!isSameCategory) {
      relatedPosts = posts.filter((p) => p.id !== post.id).slice(0, 4);
    }

    return {
      params: { slug: post.id },
      props: {
        post,
        prevPost: posts[index + 1] || null,
        nextPost: posts[index - 1] || null,
        relatedPosts,
        isSameCategory,
      },
    };
  });
}

const { post, prevPost, nextPost, relatedPosts, isSameCategory } = Astro.props;
const { Content, headings } = await render(post);
const readingTime = getReadingTime(post.body || '');
const { en: enBody } = splitContent(post.body || '');
const hasEn = enBody !== null;
const titleEn = post.data.titleEn || '';
const descriptionEn = post.data.descriptionEn || '';

const formattedDate = post.data.date.toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const tocHeadings = headings.filter((h) => h.depth <= 3);
const hasToc = tocHeadings.length > 2;

let koHeadingCount = tocHeadings.length;
if (hasEn) {
  const delimIdx = (post.body || '').indexOf('<!-- EN -->');
  if (delimIdx !== -1) {
    const koSection = (post.body || '').slice(0, delimIdx);
    const matches = koSection.match(/^#{1,3}\s/gm);
    koHeadingCount = matches ? matches.length : 0;
  }
}

const catI18n = getCategoryI18n();
const categoryEn = translateCategory(post.data.category, catI18n);
const parentCatEn = catI18n.get(parseCategory(post.data.category).parent) || parseCategory(post.data.category).parent;
---

<BaseLayout title={post.data.title} description={post.data.description} ogImage={post.data.coverImage ? assetPath(post.data.coverImage) : undefined}>
  <div class="fade-in-up">
      <!-- Main content -->
      <article class="post-article relative">
      <!-- Floating left sidebar (outside content area, like TOC on right) -->
      <div class="floating-sidebar hidden xl:block">
        <BlogSidebar />
      </div>
      <!-- Back link -->
      <a href="/blog" class="group inline-flex items-center gap-1.5 text-[12px] sm:text-[13px] text-gray-400 dark:text-gray-500 hover:text-primary dark:hover:text-primary-light transition-all duration-300 mb-8 sm:mb-10">
        <svg class="w-3.5 h-3.5 group-hover:-translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        <span data-ko="모든 글" data-en="All Posts">모든 글</span>
      </a>

      <!-- Post header -->
      <header class="mb-8 sm:mb-10">
        <div class="flex flex-wrap items-center gap-2.5 sm:gap-3 mb-4 sm:mb-5">
          <time class="text-[13px] sm:text-[14px] font-medium text-gray-500 dark:text-gray-400">
            {formattedDate}
          </time>
          <span class="w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600"></span>
          <span class="text-[13px] sm:text-[14px] text-gray-500 dark:text-gray-400">
            <span data-ko={`약 ${readingTime}분 분량`} data-en={`${readingTime} min read`}>{`약 ${readingTime}분 분량`}</span>
          </span>
          <span id="post-views-dot" class="hidden w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600"></span>
          <span id="post-views" class="hidden items-center gap-1 text-[13px] sm:text-[14px] text-gray-500 dark:text-gray-400">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span id="post-views-count">—</span>
          </span>
          <span class="w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600"></span>
          <a href={`${base}/categories/${encodeURIComponent(post.data.category)}`} class:list={['category-pill', CAT_COLOR_MAP[parseCategory(post.data.category).parent] || 'cat-default']} data-ko={post.data.category} data-en={categoryEn}>
            {post.data.category}
          </a>
        </div>
        <h1 id="post-title" class="text-xl sm:text-2xl md:text-3xl font-bold tracking-[-0.02em] leading-tight mb-4 sm:mb-5">
          {post.data.title}
        </h1>
        <div class="flex flex-wrap items-center gap-1.5">
          {post.data.tags.length > 0 && (
            post.data.tags.map((tag: string, i: number) => (
              <a href={`${base}/tags/${encodeURIComponent(tag)}`} class:list={['tag-pill text-[10px] sm:text-[11px]', TAG_COLORS[i % TAG_COLORS.length]]}>
                {tag}
              </a>
            ))
          )}
        </div>
      </header>

      <!-- Cover image -->
      {post.data.coverImage && (
        <div class="mb-8 sm:mb-10 rounded-2xl overflow-hidden">
          <img src={assetPath(post.data.coverImage)} alt="" class="w-full h-64 sm:h-80 md:h-96 object-cover" loading="lazy" />
        </div>
      )}

      <!-- Divider -->
      <div class="divider mb-8 sm:mb-10"></div>

      <!-- Inline TOC (mobile only when sidebar exists) -->
      {hasToc && (
        <details class="xl:hidden glass-card rounded-2xl p-6 mb-8 group" open>
          <summary class="flex items-center justify-between cursor-pointer text-[14px] font-semibold select-none">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
              <span data-ko="목차" data-en="Table of Contents">목차</span>
            </div>
            <svg class="w-4 h-4 text-gray-400 transform group-open:rotate-180 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <nav class="mt-4 space-y-1.5">
            {tocHeadings.map((heading, idx) => (
              <a
                href={`#${heading.slug}`}
                data-lang={hasEn ? (idx < koHeadingCount ? 'ko' : 'en') : undefined}
                class:list={[
                  'toc-item block text-[13px] text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light transition-colors duration-300 py-1',
                  heading.depth === 3 && 'pl-4',
                  hasEn && idx >= koHeadingCount && 'hidden',
                ]}
              >
                {heading.text}
              </a>
            ))}
          </nav>
        </details>
      )}

      <!-- Post content -->
      <div class="glass-gradient rounded-2xl sm:rounded-3xl p-5 sm:p-7 md:p-10">
        <div id="post-content" class="prose" data-has-en={hasEn ? 'true' : 'false'} data-title-en={titleEn}>
          <Content />
        </div>
      </div>

      <!-- Author profile -->
      <div class="mt-10 sm:mt-14">
        <AuthorCard />
      </div>

      <!-- Related posts -->
      {relatedPosts.length > 0 && (
        <div class="related-card mt-6 sm:mt-8">
          <div class="p-6 sm:p-8 md:p-10">
            <p class="text-[15px] sm:text-[16px] font-bold tracking-tight mb-5">
              {isSameCategory ? (
                <>
                  <span class="lang-ko text-gray-500 dark:text-gray-400">'{parseCategory(post.data.category).parent}'</span>
                  <span class="lang-en hidden text-gray-500 dark:text-gray-400">'{parentCatEn}'</span>
                  <span class="text-gray-400 dark:text-gray-500" data-ko=" 의 다른 글" data-en="'s other posts"> 의 다른 글</span>
                </>
              ) : (
                <span class="text-gray-500 dark:text-gray-400" data-ko="다른 글 둘러보기" data-en="More posts to read">다른 글 둘러보기</span>
              )}
            </p>
            <div class="divider mb-5"></div>
            <div class="space-y-0">
              {relatedPosts.map((rp) => (
                <a href={`${base}/blog/${rp.id}`} class="related-post-link group flex items-center justify-between gap-6">
                  <p class="text-[14px] sm:text-[15px] font-semibold group-hover:text-primary dark:group-hover:text-primary-light transition-colors duration-300 truncate">
                    {rp.data.title}
                  </p>
                  <span class="text-[18px] text-gray-300 dark:text-gray-600 group-hover:text-primary dark:group-hover:text-primary-light group-hover:translate-x-1 transition-all duration-300 shrink-0 leading-none">&rarr;</span>
                </a>
              ))}
            </div>
          </div>
        </div>
      )}

      <!-- Prev / Next navigation -->
      {(prevPost || nextPost) && (
        <nav class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-3">
          {prevPost ? (
            <a href={`${base}/blog/${prevPost.id}`} class="glass-card rounded-2xl p-5 group block">
              <span class="text-[11px] text-gray-400 dark:text-gray-500 tracking-widest uppercase flex items-center gap-1 mb-2">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                <span data-ko="이전 글" data-en="Previous">이전 글</span>
              </span>
              <span class="text-[14px] font-medium group-hover:text-primary transition-colors duration-300 line-clamp-1">
                {prevPost.data.title}
              </span>
            </a>
          ) : <div />}
          {nextPost ? (
            <a href={`${base}/blog/${nextPost.id}`} class="glass-card rounded-2xl p-5 group block text-right">
              <span class="text-[11px] text-gray-400 dark:text-gray-500 tracking-widest uppercase flex items-center justify-end gap-1 mb-2">
                <span data-ko="다음 글" data-en="Next">다음 글</span>
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
              </span>
              <span class="text-[14px] font-medium group-hover:text-primary transition-colors duration-300 line-clamp-1">
                {nextPost.data.title}
              </span>
            </a>
          ) : <div />}
        </nav>
      )}

      <!-- Comments -->
      <Giscus />

      <!-- Sidebar TOC (desktop only, floating right of article) -->
      {hasToc && (
        <aside class="hidden xl:block floating-toc">
          <div class="sticky top-24">
            <div class="glass-sidebar p-5">
              <div class="flex items-center gap-2 mb-4">
                <svg class="w-3.5 h-3.5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
                <span class="text-[13px] font-semibold tracking-wide uppercase text-gray-500 dark:text-gray-400" data-ko="목차" data-en="TOC">목차</span>
              </div>

              <!-- Progress bar -->
              <div class="h-px w-full bg-gray-200/50 dark:bg-gray-700/30 mb-4 rounded-full overflow-hidden">
                <div id="toc-progress" class="h-full bg-gradient-to-r from-primary to-accent rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>

              <nav id="sidebar-toc" class="space-y-0.5">
                {tocHeadings.map((heading, idx) => (
                  <a
                    href={`#${heading.slug}`}
                    data-heading={heading.slug}
                    data-lang={hasEn ? (idx < koHeadingCount ? 'ko' : 'en') : undefined}
                    class:list={[
                      'toc-link block text-[13px] leading-relaxed py-1.5 rounded-lg transition-all duration-300 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light',
                      heading.depth === 2 && 'pl-2',
                      heading.depth === 3 && 'pl-5',
                      hasEn && idx >= koHeadingCount && 'hidden',
                    ]}
                  >
                    {heading.text}
                  </a>
                ))}
              </nav>
            </div>
          </div>
        </aside>
      )}
    </article>
  </div>
</BaseLayout>

<style>
  :global(.lang-content) {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  :global(.lang-content.lang-hidden) {
    display: none;
  }

  :global(.lang-content.fade-in) {
    animation: langFadeIn 0.3s ease forwards;
  }

  @keyframes langFadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .related-post-link {
    padding: 0.75rem 1rem;
    border-radius: 14px;
    transition: all 0.3s ease;
  }

  .related-post-link:hover {
    background: rgba(56, 189, 248, 0.04);
  }

  :global(.dark) .related-post-link:hover {
    background: rgba(56, 189, 248, 0.06);
  }

  .related-card {
    background: rgba(255, 255, 255, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(16px) saturate(1.3);
    -webkit-backdrop-filter: blur(16px) saturate(1.3);
    border-radius: 1.25rem;
    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.03);
  }

  :global(.dark) .related-card {
    background: rgba(30, 30, 40, 0.4);
    border-color: rgba(255, 255, 255, 0.05);
    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.12);
  }

  .floating-sidebar {
    position: absolute;
    top: 0;
    bottom: 0;
    right: 100%;
    margin-right: 2rem;
    width: 13rem;
  }

  @media (min-width: 1536px) {
    .floating-sidebar {
      margin-right: 2.5rem;
    }
  }

  .floating-toc {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 100%;
    margin-left: 2rem;
    width: 200px;
  }

  @media (min-width: 1536px) {
    .floating-toc {
      width: 230px;
      margin-left: 2.5rem;
    }
  }
</style>

<script>
  function initToc() {
    const allTocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
    const progressBar = document.getElementById('toc-progress');
    if (allTocLinks.length === 0) return;

    // Only observe visible (non-hidden) TOC links
    const visibleLinks = Array.from(allTocLinks).filter((l) => !l.classList.contains('hidden'));
    const headingEls = visibleLinks.map((link) => {
      const slug = link.getAttribute('data-heading');
      return slug ? document.getElementById(slug) : null;
    }).filter(Boolean) as HTMLElement[];

    if (headingEls.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;

            allTocLinks.forEach((link) => {
              const isActive = link.getAttribute('data-heading') === id;
              if (isActive) {
                link.classList.add('text-primary', 'dark:text-primary-light', 'font-medium', 'bg-primary/[0.04]');
                link.classList.remove('text-gray-500', 'dark:text-gray-400');
              } else {
                link.classList.remove('text-primary', 'dark:text-primary-light', 'font-medium', 'bg-primary/[0.04]');
                link.classList.add('text-gray-500', 'dark:text-gray-400');
              }
            });

            if (progressBar) {
              const idx = headingEls.findIndex((el) => el.id === id);
              const pct = ((idx + 1) / headingEls.length) * 100;
              progressBar.style.width = `${pct}%`;
            }
          }
        });
      },
      { rootMargin: '-80px 0px -60% 0px', threshold: 0.1 }
    );

    headingEls.forEach((el) => observer.observe(el));

    // Re-init when language changes
    (window as any).__tocObserver?.disconnect();
    (window as any).__tocObserver = observer;
  }

  (window as any).initTocFn = initToc;
  initToc();
  document.addEventListener('astro:page-load', initToc);
</script>

<script>
  // Post-level language integration with global toggle
  // Note: innerHTML usage here is safe - content comes from Astro's own
  // server-rendered markdown (Content component), not user input.
  function initPostLang() {
    const contentEl = document.getElementById('post-content');
    const titleEl = document.getElementById('post-title');
    if (!contentEl) return;

    const hasEn = contentEl.dataset.hasEn === 'true';
    if (!hasEn) return;

    const titleKo = titleEl?.textContent || '';
    const titleEn = contentEl.dataset.titleEn || '';

    // Split server-rendered Astro markdown by delimiter
    const fullHtml = contentEl.innerHTML;
    const delimiter = '<!-- EN -->';
    const delimIdx = fullHtml.indexOf(delimiter);
    if (delimIdx === -1) return;

    const koHtml = fullHtml.slice(0, delimIdx).trim();
    const enHtml = fullHtml.slice(delimIdx + delimiter.length).trim();

    // Build DOM from trusted server content
    contentEl.textContent = '';
    const koDiv = document.createElement('div');
    koDiv.id = 'content-ko';
    koDiv.className = 'lang-content';
    const koTemplate = document.createElement('template');
    koTemplate.innerHTML = koHtml;
    koDiv.appendChild(koTemplate.content);

    const enDiv = document.createElement('div');
    enDiv.id = 'content-en';
    enDiv.className = 'lang-content lang-hidden';
    const enTemplate = document.createElement('template');
    enTemplate.innerHTML = enHtml;
    enDiv.appendChild(enTemplate.content);

    contentEl.appendChild(koDiv);
    contentEl.appendChild(enDiv);

    function setPostLang(lang: string) {
      if (lang === 'en') {
        koDiv.classList.add('lang-hidden');
        koDiv.classList.remove('fade-in');
        enDiv.classList.remove('lang-hidden');
        enDiv.classList.add('fade-in');
        if (titleEl && titleEn) titleEl.textContent = titleEn;
      } else {
        enDiv.classList.add('lang-hidden');
        enDiv.classList.remove('fade-in');
        koDiv.classList.remove('lang-hidden');
        koDiv.classList.add('fade-in');
        if (titleEl) titleEl.textContent = titleKo;
      }

      // Switch TOC headings to match language
      document.querySelectorAll<HTMLElement>('.toc-link[data-lang], .toc-item[data-lang]').forEach((el) => {
        const linkLang = el.getAttribute('data-lang');
        if (linkLang === lang) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });

      // Re-init TOC observer for the new language's headings
      if (typeof (window as any).initTocFn === 'function') {
        (window as any).initTocFn();
      }
    }

    // Init from current global language
    const saved = localStorage.getItem('preferred-lang') || 'ko';
    setPostLang(saved);

    // Listen for global language changes — abort previous to prevent accumulation
    if ((window as any).__postLangAC) (window as any).__postLangAC.abort();
    (window as any).__postLangAC = new AbortController();
    window.addEventListener('lang-changed', (e: any) => {
      setPostLang(e.detail.lang);
    }, { signal: (window as any).__postLangAC.signal });
  }

  initPostLang();
  document.addEventListener('astro:page-load', initPostLang);
</script>

<script>
  const GC_HOST = 'https://itoasis.goatcounter.com';

  function loadPostViews() {
    const el = document.getElementById('post-views-count');
    const wrapper = document.getElementById('post-views');
    const dot = document.getElementById('post-views-dot');
    if (!el || !wrapper) return;

    // GoatCounter records the full pathname (including base path)
    const pagePath = window.location.pathname.replace(/\/$/, '') || '/';

    fetch(`${GC_HOST}/counter/${encodeURIComponent(pagePath)}.json`)
      .then(r => r.json())
      .then(data => {
        el.textContent = data.count;
        wrapper.classList.remove('hidden');
        wrapper.classList.add('inline-flex');
        if (dot) dot.classList.remove('hidden');
      })
      .catch(() => {
        // No views yet or API error — keep hidden
      });
  }

  loadPostViews();
  document.addEventListener('astro:page-load', loadPostViews);
</script>

