---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { buildCategoryTree, parseCategory } from '../../lib/utils';
import { base, getCategoryI18n, getCategoryDisplayKo } from '../../lib/config';
import { getPublishedPosts } from '../../lib/posts';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  const tree = buildCategoryTree(posts.map(p => p.data.category));

  const paths: any[] = [];

  for (const [parent, node] of tree) {
    // Parent category page — shows ALL posts under this parent
    paths.push({
      params: { category: parent },
      props: {
        category: parent,
        displayName: parent,
        isParent: true,
        posts: posts
          .filter(p => parseCategory(p.data.category).parent === parent)
          .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
        children: [...node.children.entries()].sort((a, b) => b[1].count - a[1].count),
      },
    });

    // Child category pages
    for (const [child] of node.children) {
      const fullCategory = `${parent}/${child}`;
      paths.push({
        params: { category: fullCategory },
        props: {
          category: fullCategory,
          displayName: child,
          isParent: false,
          posts: posts
            .filter(p => p.data.category === fullCategory)
            .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
          children: [],
        },
      });
    }
  }

  return paths;
}

const { category, displayName, isParent, posts, children } = Astro.props;
const parsed = parseCategory(category);
const catI18n = getCategoryI18n();
const catDisplayKo = getCategoryDisplayKo();
const displayNameKo = catDisplayKo.get(displayName) || displayName;
const displayNameEn = catI18n.get(displayName) || displayName;
const parentNameEn = parsed.parent ? (catI18n.get(parsed.parent) || parsed.parent) : '';
---

<BaseLayout title={`Category: ${category}`}>
  <div class="fade-in-up">
    <a href={`${base}/categories`} class="group inline-flex items-center gap-1.5 text-[13px] font-medium text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light transition-all duration-300 mb-8">
      <svg class="w-3.5 h-3.5 group-hover:-translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      <span data-ko="모든 카테고리" data-en="All Categories">모든 카테고리</span>
    </a>

    <!-- Breadcrumb for sub-categories -->
    {!isParent && parsed.parent && (
      <div class="flex items-center gap-2 text-[13px] text-gray-500 dark:text-gray-400 mb-4 px-1">
        <a href={`${base}/categories/${encodeURIComponent(parsed.parent)}`} class="hover:text-primary transition-colors" data-ko={parsed.parent} data-en={parentNameEn}>
          {parsed.parent}
        </a>
        <svg class="w-3 h-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-600 dark:text-gray-300 font-medium" data-ko={displayNameKo} data-en={displayNameEn}>{displayNameKo}</span>
      </div>
    )}

    <h1 class="text-xl sm:text-2xl font-bold tracking-tight mb-2 px-1">
      <span class="gradient-text" data-ko={displayNameKo} data-en={displayNameEn}>{displayNameKo}</span>
    </h1>
    <p class="text-[13px] sm:text-[14px] font-medium text-gray-500 dark:text-gray-400 mb-8 sm:mb-10 px-1">
      {posts.length}<span data-ko="개의 글" data-en=" posts">개의 글</span>
    </p>

    <!-- Sub-category chips for parent categories -->
    {isParent && children.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8 px-1">
        {children.map(([child, childNode]: [string, any]) => (
          <a
            href={`${base}/categories/${encodeURIComponent(category)}/${encodeURIComponent(child)}`}
            class="text-[12px] font-medium px-4 py-2 rounded-xl glass-card text-gray-600 dark:text-gray-400 hover:text-primary transition-colors"
          >
            <span data-ko={catDisplayKo.get(child) || child} data-en={catI18n.get(child) || child}>{catDisplayKo.get(child) || child}</span>
            <span class="ml-1.5 text-[11px] text-gray-400 dark:text-gray-500">{childNode.count}</span>
          </a>
        ))}
      </div>
    )}
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5 stagger">
    {posts.map((post: any, i: number) => (
      <PostCard
        title={post.data.title}
        description={post.data.description}
        date={post.data.date}
        slug={post.id}
        tags={post.data.tags}
        category={post.data.category}
        coverImage={post.data.coverImage}
        index={i}
      />
    ))}
  </div>
</BaseLayout>
