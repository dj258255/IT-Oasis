---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { buildCategoryTree, defaultIconPath } from '../../lib/utils';
import { base, getCategoryI18n, getCategoryMeta, getCategoryDisplayKo } from '../../lib/config';
import { getPublishedPosts } from '../../lib/posts';
const posts = await getPublishedPosts();
const categoryTree = buildCategoryTree(posts.map(p => p.data.category));
const sortedParents = [...categoryTree.entries()].sort((a, b) => b[1].count - a[1].count);

const catMetaRaw = getCategoryMeta();
const catMeta = new Map([...catMetaRaw.entries()].map(([k, v]) => [k, { icon: v.icon, gradient: 'from-primary/15 to-accent/15' }]));
const catI18n = getCategoryI18n();
const catDisplayKo = getCategoryDisplayKo();
const defaultGradient = 'from-cyan/15 to-emerald/15';
---

<BaseLayout title="Categories">
  <div class="fade-in-up">
    <h1 class="text-xl sm:text-2xl font-bold tracking-tight mb-2 px-1">
      <span class="gradient-text">Categories</span>
    </h1>
    <p class="text-[12px] sm:text-[13px] text-gray-400 dark:text-gray-500 mb-8 sm:mb-10 px-1">
      {sortedParents.length}<span data-ko="개의 카테고리" data-en=" categories">개의 카테고리</span>
    </p>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 stagger">
      {sortedParents.map(([parent, node]) => (
        <a
          href={`${base}/categories/${encodeURIComponent(parent)}`}
          class="glass-card rounded-xl sm:rounded-2xl p-5 sm:p-7 group block relative overflow-hidden"
        >
          <div class:list={["absolute -top-8 -right-8 w-24 h-24 rounded-full bg-gradient-to-br blur-2xl opacity-60 pointer-events-none group-hover:opacity-100 transition-opacity duration-500", catMeta.get(parent)?.gradient || defaultGradient]}></div>
          <div class="relative">
            <div class="flex items-center gap-3 mb-4">
              <div class:list={["w-10 h-10 rounded-2xl bg-gradient-to-br flex items-center justify-center group-hover:scale-110 transition-transform duration-500", catMeta.get(parent)?.gradient || defaultGradient]}>
                <svg class="w-4.5 h-4.5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d={catMeta.get(parent)?.icon || defaultIconPath} />
                </svg>
              </div>
              <span class="text-[12px] font-semibold px-3 py-1 rounded-full bg-primary/[0.06] text-primary/60">
                {node.count}<span data-ko="개의 글" data-en=" posts">개의 글</span>
              </span>
            </div>
            <h2 class="text-[18px] font-bold group-hover:text-primary transition-colors duration-300 mb-1" data-ko={parent} data-en={catI18n.get(parent) || parent}>
              {parent}
            </h2>
            {node.children.size > 0 && (
              <div class="flex flex-wrap gap-1.5 mt-3">
                {[...node.children.entries()].sort((a, b) => b[1].count - a[1].count).map(([child, childNode]) => (
                  <span class="text-[11px] text-gray-400 dark:text-gray-500 bg-gray-100/60 dark:bg-gray-800/40 px-2.5 py-1 rounded-lg">
                    <span data-ko={catDisplayKo.get(child) || child} data-en={catI18n.get(child) || child}>{catDisplayKo.get(child) || child}</span> <span class="opacity-60">{childNode.count}</span>
                  </span>
                ))}
              </div>
            )}
          </div>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>
