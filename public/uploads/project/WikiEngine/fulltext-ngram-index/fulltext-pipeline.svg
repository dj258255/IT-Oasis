<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 720 980" width="720" height="980" font-family="'Noto Sans KR', 'Malgun Gothic', sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#555"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c"/>
    </marker>
    <filter id="shadow" x="-5%" y="-5%" width="110%" height="110%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="#00000022"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="720" height="980" fill="#f8f9fa" rx="12"/>

  <!-- Title -->
  <rect x="20" y="16" width="680" height="48" rx="8" fill="#2c3e50" filter="url(#shadow)"/>
  <text x="360" y="47" text-anchor="middle" fill="white" font-size="18" font-weight="bold">FULLTEXT 쿼리 처리 파이프라인</text>

  <!-- ── Step 1: Input Query ── -->
  <rect x="260" y="88" width="200" height="44" rx="22" fill="#3498db" filter="url(#shadow)"/>
  <text x="360" y="115" text-anchor="middle" fill="white" font-size="15" font-weight="bold">"대한민국"</text>

  <!-- arrow down -->
  <line x1="360" y1="132" x2="360" y2="156" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ── Step 2: ngram 분할 ── -->
  <rect x="240" y="158" width="240" height="40" rx="8" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="360" y="183" text-anchor="middle" fill="#2c3e50" font-size="13">ngram 분할 (2-gram)</text>

  <!-- arrows fan out -->
  <line x1="360" y1="198" x2="200" y2="232" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="360" y1="198" x2="360" y2="232" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="360" y1="198" x2="520" y2="232" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ── Step 3: Tokens ── -->
  <rect x="128" y="234" width="144" height="40" rx="8" fill="#2ecc71" filter="url(#shadow)"/>
  <text x="200" y="259" text-anchor="middle" fill="white" font-size="14" font-weight="bold">"대한"</text>

  <rect x="288" y="234" width="144" height="40" rx="8" fill="#2ecc71" filter="url(#shadow)"/>
  <text x="360" y="259" text-anchor="middle" fill="white" font-size="14" font-weight="bold">"한민"</text>

  <rect x="448" y="234" width="144" height="40" rx="8" fill="#2ecc71" filter="url(#shadow)"/>
  <text x="520" y="259" text-anchor="middle" fill="white" font-size="14" font-weight="bold">"민국"</text>

  <!-- arrows down to index table -->
  <line x1="200" y1="274" x2="200" y2="308" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="360" y1="274" x2="360" y2="308" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="520" y1="274" x2="520" y2="308" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ── Step 4: 역색인 보조 테이블 ── -->
  <rect x="80" y="310" width="560" height="80" rx="10" fill="#fff" stroke="#3498db" stroke-width="2" filter="url(#shadow)"/>
  <text x="360" y="338" text-anchor="middle" fill="#2c3e50" font-size="13" font-weight="bold">6개 보조 테이블 (역색인)</text>
  <text x="360" y="358" text-anchor="middle" fill="#7f8c8d" font-size="12">token  →  posting list</text>
  <!-- decorative lines -->
  <line x1="100" y1="368" x2="620" y2="368" stroke="#ecf0f1" stroke-width="1"/>
  <rect x="100" y="372" width="90" height="12" rx="4" fill="#ecf0f1"/>
  <rect x="200" y="372" width="90" height="12" rx="4" fill="#ecf0f1"/>
  <rect x="300" y="372" width="90" height="12" rx="4" fill="#ecf0f1"/>
  <rect x="400" y="372" width="90" height="12" rx="4" fill="#ecf0f1"/>
  <rect x="500" y="372" width="110" height="12" rx="4" fill="#ecf0f1"/>

  <!-- arrows down to posting counts -->
  <line x1="200" y1="390" x2="200" y2="420" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="360" y1="390" x2="360" y2="420" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="520" y1="390" x2="520" y2="420" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ── Step 5: Posting counts ── -->
  <rect x="112" y="422" width="176" height="44" rx="8" fill="#e8f4fd" stroke="#3498db" stroke-width="1.5"/>
  <text x="200" y="439" text-anchor="middle" fill="#2980b9" font-size="11">매칭 문서 수</text>
  <text x="200" y="458" text-anchor="middle" fill="#2c3e50" font-size="15" font-weight="bold">196,593</text>

  <rect x="272" y="422" width="176" height="44" rx="8" fill="#e8f4fd" stroke="#3498db" stroke-width="1.5"/>
  <text x="360" y="439" text-anchor="middle" fill="#2980b9" font-size="11">매칭 문서 수</text>
  <text x="360" y="458" text-anchor="middle" fill="#2c3e50" font-size="15" font-weight="bold">45,200</text>

  <rect x="432" y="422" width="176" height="44" rx="8" fill="#e8f4fd" stroke="#3498db" stroke-width="1.5"/>
  <text x="520" y="439" text-anchor="middle" fill="#2980b9" font-size="11">매칭 문서 수</text>
  <text x="520" y="458" text-anchor="middle" fill="#2c3e50" font-size="15" font-weight="bold">38,100</text>

  <!-- arrows converge -->
  <line x1="200" y1="466" x2="340" y2="508" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="360" y1="466" x2="360" y2="508" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="520" y1="466" x2="380" y2="508" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ── Step 6: Intersection ── -->
  <rect x="160" y="510" width="400" height="72" rx="10" fill="#fff" stroke="#27ae60" stroke-width="2" filter="url(#shadow)"/>
  <text x="360" y="535" text-anchor="middle" fill="#27ae60" font-size="13" font-weight="bold">교집합 연산 (RB-tree 기반)</text>
  <text x="360" y="556" text-anchor="middle" fill="#7f8c8d" font-size="12">O(n log n)</text>
  <rect x="240" y="562" width="88" height="14" rx="4" fill="#d5f5e3"/>
  <text x="284" y="573" text-anchor="middle" fill="#27ae60" font-size="10" font-weight="bold">✓ 여기는 OK</text>

  <!-- arrow -->
  <line x1="360" y1="582" x2="360" y2="614" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ── Step 7: Candidate docs ── -->
  <rect x="260" y="616" width="200" height="44" rx="22" fill="#f39c12" filter="url(#shadow)"/>
  <text x="360" y="637" text-anchor="middle" fill="white" font-size="13" font-weight="bold">~30,000 후보 문서</text>
  <text x="360" y="652" text-anchor="middle" fill="white" font-size="11">(교집합 결과)</text>

  <!-- arrow -->
  <line x1="360" y1="660" x2="360" y2="692" stroke="#e74c3c" stroke-width="2.5" marker-end="url(#arrow-red)"/>

  <!-- ── Step 8: Phrase Verification (BOTTLENECK) ── -->
  <rect x="100" y="694" width="520" height="120" rx="10" fill="#fef9f9" stroke="#e74c3c" stroke-width="2.5" filter="url(#shadow)"/>
  <!-- red badge -->
  <rect x="236" y="686" width="248" height="22" rx="11" fill="#e74c3c"/>
  <text x="360" y="701" text-anchor="middle" fill="white" font-size="11" font-weight="bold">★ 병목 구간 ★</text>
  <text x="360" y="722" text-anchor="middle" fill="#c0392b" font-size="14" font-weight="bold">구절 검증 (Phrase Verification)</text>
  <text x="360" y="743" text-anchor="middle" fill="#7f8c8d" font-size="12">ib_vector_t 기반 순차 탐색</text>
  <line x1="120" y1="752" x2="600" y2="752" stroke="#fadbd8" stroke-width="1"/>
  <text x="360" y="770" text-anchor="middle" fill="#e74c3c" font-size="12">각 문서 × 각 위치 × 나머지 토큰 순차 비교</text>
  <text x="360" y="790" text-anchor="middle" fill="#c0392b" font-size="13" font-weight="bold">O(문서 수 × 위치 수)</text>
  <!-- warning icon area -->
  <text x="120" y="756" fill="#e74c3c" font-size="20">⚠</text>
  <text x="578" y="756" fill="#e74c3c" font-size="20">⚠</text>

  <!-- arrow -->
  <line x1="360" y1="814" x2="360" y2="846" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ── Step 9: IDF Ranking ── -->
  <rect x="160" y="848" width="400" height="56" rx="10" fill="#fff" stroke="#9b59b6" stroke-width="2" filter="url(#shadow)"/>
  <text x="360" y="873" text-anchor="middle" fill="#8e44ad" font-size="13" font-weight="bold">IDF 기반 랭킹 + 정렬</text>
  <text x="360" y="893" text-anchor="middle" fill="#7f8c8d" font-size="12">관련도 스코어 계산 및 상위 결과 추출</text>

  <!-- arrow -->
  <line x1="360" y1="904" x2="360" y2="934" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ── Step 10: Final Result ── -->
  <rect x="260" y="936" width="200" height="28" rx="14" fill="#2c3e50"/>
  <text x="360" y="955" text-anchor="middle" fill="white" font-size="13" font-weight="bold">최종 결과 반환</text>
</svg>
